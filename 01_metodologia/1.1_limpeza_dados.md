# 1.1 Etapa 0: Limpeza e Validação de Dados

## Visão Geral

A etapa de limpeza e validação é fundamental para garantir a qualidade dos dados que alimentarão todo o pipeline de Machine Learning. Esta etapa processa os dados brutos da Receita Federal, removendo inconsistências, duplicatas e registros inválidos.

## Objetivos

1. Validar format de CNPJs (8 dígitos numéricos)
2. Remover registros duplicados
3. Identificar e segregar registros inválidos
4. Garantir consistência nos dados de entrada
5. Preparar dados limpos para agregação

## Arquivo de Implementação

**Notebook:** `08_codigo/notebooks/0.0.1_limpeza.ipynb`

**Localização dos dados:**
- **Entrada:** `estabelecimentos_rs.csv` (raiz do projeto original)
- **Saída:** `1_estabelecimentos_rs_sem_duplicados.csv`
- **Log:** `1_estabelecimentos_rs_cnpjs_basicos_invalidos.csv`

## Metodologia Detalhada

### 1. Carregamento de Dados

```python
import pandas as pd
import numpy as np

# Carrega dados brutos com inferência de tipos
df_raw = pd.read_csv('estabelecimentos_rs.csv', low_memory=False)

print(f"Dados carregados: {len(df_raw):,} registros")
print(f"Colunas: {df_raw.shape[1]}")
print(f"Memória utilizada: {df_raw.memory_usage(deep=True).sum() / 1024**2:.2f} MB")
```

**Considerações:**
- `low_memory=False`: Evita avisos de tipos mistos, analisa todo arquivo primeiro
- Verificação de tamanho: Importante para planejar processamento

### 2. Validação de CNPJ

#### 2.1 Extração do CNPJ Básico

O CNPJ completo tem 14 dígitos (XX.XXX.XXX/XXXX-XX). O **CNPJ básico** são os 8 primeiros dígitos que identificam a empresa matriz.

```python
# Extrai CNPJ básico (8 primeiros dígitos)
df_raw['cnpj_basico_str'] = df_raw['cnpj_basico'].astype(str)

# Remove caracteres não-numéricos se existirem
df_raw['cnpj_basico_str'] = df_raw['cnpj_basico_str'].str.replace(r'[^0-9]', '', regex=True)

# Preenche com zeros à esquerda se necessário
df_raw['cnpj_basico_str'] = df_raw['cnpj_basico_str'].str.zfill(8)
```

#### 2.2 Critérios de Validação

Um CNPJ básico é considerado **válido** se:
1. Tem exatamente 8 dígitos
2. Todos os caracteres são numéricos
3. Não é composto apenas de zeros (00000000)
4. Não é vazio ou NaN

```python
def validar_cnpj_basico(cnpj_str):
    """
    Valida formato de CNPJ básico
    
    Args:
        cnpj_str: String com CNPJ básico
    
    Returns:
        bool: True se válido, False caso contrário
    """
    # Verificações básicas
    if pd.isna(cnpj_str) or cnpj_str == '':
        return False
    
    # Converte para string se necessário
    cnpj_str = str(cnpj_str)
    
    # Remove espaços
    cnpj_str = cnpj_str.strip()
    
    # Verifica se tem exatamente 8 dígitos
    if len(cnpj_str) != 8:
        return False
    
    # Verifica se todos são dígitos
    if not cnpj_str.isdigit():
        return False
    
    # Verifica se não é todos zeros
    if cnpj_str == '00000000':
        return False
    
    return True

# Aplica validação
df_raw['cnpj_valido'] = df_raw['cnpj_basico_str'].apply(validar_cnpj_basico)
```

#### 2.3 Segregação de Registros

```python
# Separa válidos e inválidos
df_validos = df_raw[df_raw['cnpj_valido']].copy()
df_invalidos = df_raw[~df_raw['cnpj_valido']].copy()

print(f"\nResultados da Validação:")
print(f"  CNPJs válidos: {len(df_validos):,} ({len(df_validos)/len(df_raw)*100:.2f}%)")
print(f"  CNPJs inválidos: {len(df_invalidos):,} ({len(df_invalidos)/len(df_raw)*100:.2f}%)")

# Salva inválidos para auditoria
if len(df_invalidos) > 0:
    df_invalidos.to_csv('1_estabelecimentos_rs_cnpjs_basicos_invalidos.csv', index=False)
    print(f"  ⚠️ Inválidos salvos em: 1_estabelecimentos_rs_cnpjs_basicos_invalidos.csv")
```

### 3. Remoção de Duplicatas

#### 3.1 Identificação de Duplicatas

```python
# Verifica duplicatas completas (todos os campos iguais)
duplicatas_completas = df_validos.duplicated(keep=False)
n_duplicatas_completas = duplicatas_completas.sum()

print(f"\nDuplicatas Completas:")
print(f"  Total de registros duplicados: {n_duplicatas_completas:,}")

# Verifica duplicatas por CNPJ básico (mesmo CNPJ, campos diferentes)
duplicatas_cnpj = df_validos.duplicated(subset=['cnpj_basico_str'], keep=False)
n_duplicatas_cnpj = duplicatas_cnpj.sum()

print(f"\nDuplicatas por CNPJ:")
print(f"  Total de registros com CNPJ duplicado: {n_duplicatas_cnpj:,}")
print(f"  CNPJs únicos com duplicação: {df_validos[duplicatas_cnpj]['cnpj_basico_str'].nunique():,}")
```

#### 3.2 Estratégia de Desduplicação

**Estratégia Adotada:** Manter apenas a **primeira ocorrência** de cada CNPJ básico.

**Justificativa:**
- Dados da Receita Federal são ordenados cronologicamente
- Primeira ocorrência geralmente é o registro mais antigo/original
- Simples e determinístico (reproduzível)

**Alternativas Consideradas:**
- Manter última ocorrência: Poderia ter dados mais atualizados, mas menos estável
- Consolidar informações: Complexo e sujeito a erros, requer regras específicas por campo
- Análise manual: Inviável para milhões de registros

```python
# Remove duplicatas mantendo primeira ocorrência
df_sem_duplicatas = df_validos.drop_duplicates(subset=['cnpj_basico_str'], keep='first')

print(f"\nRemoção de Duplicatas:")
print(f"  Registros antes: {len(df_validos):,}")
print(f"  Registros após: {len(df_sem_duplicatas):,}")
print(f"  Duplicatas removidas: {len(df_validos) - len(df_sem_duplicatas):,}")
```

### 4. Verificação de Qualidade Final

```python
# Estatísticas finais
print(f"\n{'='*60}")
print(f"RESUMO DA LIMPEZA")
print(f"{'='*60}")
print(f"Registros originais:      {len(df_raw):,}")
print(f"CNPJs inválidos removidos: {len(df_invalidos):,}")
print(f"Duplicatas removidas:      {len(df_validos) - len(df_sem_duplicatas):,}")
print(f"Registros finais:          {len(df_sem_duplicatas):,}")
print(f"Taxa de retenção:          {len(df_sem_duplicatas)/len(df_raw)*100:.2f}%")
print(f"{'='*60}")

# Verifica se há valores nulos críticos
print(f"\nValores Ausentes (Críticos):")
print(df_sem_duplicatas[['cnpj_basico_str', 'situacao_cadastral', 
                          'data_inicio_atividade']].isnull().sum())

# Verifica distribuição de situação cadastral
print(f"\nDistribuição de Situação Cadastral:")
print(df_sem_duplicatas['situacao_cadastral'].value_counts())
```

### 5. Salvamento de Dados Limpos

```python
# Salva dados limpos
output_file = '1_estabelecimentos_rs_sem_duplicados.csv'
df_sem_duplicatas.to_csv(output_file, index=False)

print(f"\n✅ Dados limpos salvos em: {output_file}")
print(f"   Tamanho do arquivo: {os.path.getsize(output_file) / 1024**2:.2f} MB")
```

## Resultados Esperados

### Estatísticas Típicas

Com base em execuções do pipeline:

| Métrica | Valor Típico |
|---------|--------------|
| Registros originais | ~3.000.000 |
| CNPJs inválidos | < 1% (~10.000) |
| Duplicatas | ~5-10% (~150.000-300.000) |
| Registros finais | ~2.685.868 |
| Taxa de retenção | ~90-95% |

### Distribuição de Situação Cadastral (após limpeza)

| Situação | Proporção Típica |
|----------|------------------|
| ATIVA | ~55-65% |
| BAIXADA | ~30-40% |
| SUSPENSA | ~3-5% |
| INAPTA | ~1-2% |
| NULA | < 1% |

## Decisões de Design

### 1. Por Que Remover ao Invés de Corrigir CNPJs Inválidos?

**Decisão:** Remover registros com CNPJ inválido

**Justificativa:**
- CNPJ é identificador primário: sem ele, registro é inútil
- Correção automática é arriscada (pode criar CNPJs fictícios)
- Quantidade de inválidos é pequena (< 1%)
- Registros inválidos provavelmente têm outros problemas

### 2. Por Que Manter Primeira Ocorrência em Duplicatas?

**Decisão:** `keep='first'` ao invés de `keep='last'` ou consolidação

**Justificativa:**
- **Consistência temporal:** Primeira ocorrência é registro original
- **Simplicidade:** Regra clara e determinística
- **Reprodutibilidade:** Resultado idêntico em múltiplas execuções
- **Performance:** Operação mais rápida que consolidação

**Trade-off:**
- ✅ Simples e rápido
- ✅ Reproduzível
- ❌ Pode perder atualizações em registros posteriores
- ❌ Não consolida informações complementares

### 3. Por Que Não Validar Dígitos Verificadores do CNPJ?

**Decisão:** Validar apenas formato (8 dígitos), não algoritmo de verificação

**Justificativa:**
- Dados vêm da Receita Federal (fonte oficial)
- CNPJs já foram validados na origem
- Adicionar validação de dígitos verificadores é redundante
- Performance: Validação de formato é muito mais rápida

## Limitações

### 1. Sem Validação Semântica

**Limitação:** Validamos apenas formato, não significado

**Exemplos de problemas não detectados:**
- Empresas que deveriam ter sido baixadas mas constam ativas
- Datas inconsistentes (ex: data de início > data atual)
- Situações cadastrais incoerentes

**Mitigação:**
- Validações adicionais em etapas posteriores
- Análise exploratória (EDA) identifica inconsistências
- Features derivadas capturam anomalias

### 2. Perda de Informação em Duplicatas

**Limitação:** Ao manter apenas primeira ocorrência, informações de registros posteriores são descartadas

**Exemplo:**
- CNPJ tem 3 registros com datas diferentes
- Mantemos o primeiro
- Atualizações de endereço, porte, etc. nos registros 2 e 3 são perdidas

**Mitigação Parcial:**
- Para maioria dos casos, dados não mudam entre duplicatas
- Features críticas (situação cadastral) são atualizadas em etapas posteriores
- Quantidade de duplicatas é relativamente pequena (~5-10%)

### 3. Registros Válidos Mas Problemáticos

**Limitação:** CNPJ válido não garante que dados do registro sejam úteis

**Exemplos:**
- Empresas com todas as datas faltantes
- Registros com apenas CNPJ, sem outras informações
- Situações cadastrais indefinidas

**Mitigação:**
- Etapas posteriores (feature engineering) tratam valores ausentes
- Imputação e encoding lidam com campos faltantes
- Features derivadas criam indicadores de qualidade

## Próximos Passos

Após a limpeza, os dados estão prontos para:

1. **Etapa 1: Agregação** (`1.2_agregacao_features.md`)
   - Combinar com outras fontes
   - Agregar informações complementares

2. **Etapa 2: Feature Engineering** (`1.3_feature_engineering.md`)
   - Criar features derivadas
   - Calcular targets de sobrevivência

## Auditoria e Reprodutibilidade

### Logs Gerados

- `1_estabelecimentos_rs_cnpjs_basicos_invalidos.csv`: CNPJs inválidos removidos

### Verificação de Integridade

```python
# Script de verificação (executar após limpeza)
def verificar_limpeza(arquivo_limpo):
    df = pd.read_csv(arquivo_limpo)
    
    # Verificações
    assert df['cnpj_basico_str'].str.len().eq(8).all(), "CNPJs devem ter 8 dígitos"
    assert df['cnpj_basico_str'].str.isdigit().all(), "CNPJs devem ser numéricos"
    assert not df['cnpj_basico_str'].duplicated().any(), "Não deve haver duplicatas"
    assert df['cnpj_basico_str'].ne('00000000').all(), "CNPJs não podem ser zeros"
    
    print("✅ Todas as verificações passaram!")
    return True

# Executar verificação
verificar_limpeza('1_estabelecimentos_rs_sem_duplicados.csv')
```

## Referências

- Receita Federal do Brasil. Cadastro Nacional da Pessoa Jurídica (CNPJ). [https://www.gov.br/receitafederal/dados-abertos](https://www.gov.br/receitafederal/dados-abertos)
- Pandas Documentation. [https://pandas.pydata.org/docs/](https://pandas.pydata.org/docs/)

---

**Documento:** 1.1_limpeza_dados.md  
**Versão:** 1.0  
**Data:** Dezembro 2024  
**Próximo:** [1.2 Agregação de Features](1.2_agregacao_features.md)

